---
apiVersion: v1
kind: Pod
metadata:
  name: web-server-pod
spec:
  initContainers:
    - name: init-service
      image: busybox:latest
      command: ['sh', '-c', 'echo "Init container started!"']
  containers:
    - name: nginx-web-server
      image: nginx:latest
      ports:
        - containerPort: 80
      volumeMounts:
        - mountPath: /var/cache/nginx
          name: nginx-cache
        - mountPath: /var/run
          name: var-run
        - name: nginx-config
          mountPath: /etc/nginx
      securityContext:
        capabilities:
          drop:
            - ALL
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 1000
      resources:
        requests:
          cpu: 100m
          memory: 126Mi
        limits:
          cpu: 200m
          memory: 256Mi
      readinessProbe:
        httpGet:
          port: 80
          path: /index.html
        initialDelaySeconds: 5
        periodSeconds: 5
      livenessProbe:
        httpGet:
          port: 80
          path: /index.html
        initialDelaySeconds: 15
        periodSeconds: 20
        timeoutSeconds: 20
      startupProbe:
        httpGet:
          port: /index.html
          path: 80
        initialDelaySeconds: 30
        failureThreshold: 30
        periodSeconds: 10
      lifecycle:
        postStart:
          exec:
            command: ["/bin/sh","-c","echo 'Post Start'"]
        preStop:
          exec:
            command: ["/bin/sh","-c","echo 'Pre Stop'"]
  serviceAccountName: nginx-service-account
  securityContext:
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 2000
  shareProcessNamespace: true
  volumes:
    - name: nginx-cache
      emptyDir: {}
    - name: var-run
      emptyDir: {}
    - name: nginx-config
      configMap:
        name: nginx-config

